@rem 
@rem Author:: Seth Chisamore (<schisamo@opscode.com>) 
@rem Copyright:: Copyright (c) 2011 Opscode, Inc. 
@rem License:: Apache License, Version 2.0 
@rem 
@rem Licensed under the Apache License, Version 2.0 (the "License"); 
@rem you may not use this file except in compliance with the License. 
@rem You may obtain a copy of the License at 
@rem 
@rem     http://www.apache.org/licenses/LICENSE-2.0 
@rem 
@rem Unless required by applicable law or agreed to in writing, software 
@rem distributed under the License is distributed on an "AS IS" BASIS, 
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
@rem See the License for the specific language governing permissions and 
@rem limitations under the License. 
@rem 

@rem Use delayed environment expansion so that ERRORLEVEL can be evaluated with the 
@rem !ERRORLEVEL! syntax which evaluates at execution of the line of script, not when 
@rem the line is read. See help for the /E switch from cmd.exe /? . 
@setlocal ENABLEDELAYEDEXPANSION 

@set BOOTSTRAP_DIRECTORY=<%= bootstrap_directory %> 
@echo Checking for existing directory "%BOOTSTRAP_DIRECTORY%"... 
@if NOT EXIST %BOOTSTRAP_DIRECTORY% ( 
    @echo Existing directory not found, creating. 
    @mkdir %BOOTSTRAP_DIRECTORY% 
) else ( 
    @echo Existing directory found, skipping creation. 
) 

@rem If user has provided the custom installation command for chef-client then execute it
<% if @chef_config[:knife][:bootstrap_install_command] %> 
  <%= @chef_config[:knife][:bootstrap_install_command] %> 
<% else %> 
  powershell.exe -File "%TEMP%\chef-installer.ps1"
<% end %> 

@endlocal 

@echo off 

<% if client_pem -%> 
> <%= bootstrap_directory %>\client.pem ( 
 <%= escape_and_echo(::File.read(::File.expand_path(client_pem))) %> 
) 
<% end -%> 

echo Writing validation key... 

<% if validation_key -%> 
> <%= bootstrap_directory %>\validation.pem ( 
 <%= escape_and_echo(validation_key) %> 
) 
<% end -%> 

echo Validation key written. 
@echo on 

<% if @config[:secret] -%> 
> <%= bootstrap_directory %>\encrypted_data_bag_secret ( 
 <%= secret %> 
) 
<% end -%> 

<% unless trusted_certs_script.empty? -%> 
mkdir <%= bootstrap_directory %>\trusted_certs 
<%= trusted_certs_script %> 
<% end -%> 

<%# Generate Ohai Hints -%> 
<% unless @chef_config[:knife][:hints].nil? || @chef_config[:knife][:hints].empty? -%> 
mkdir <%= bootstrap_directory %>\ohai\hints 

<% @chef_config[:knife][:hints].each do |name, hash| -%> 
> <%= bootstrap_directory %>\ohai\hints\<%= name %>.json ( 
  <%= escape_and_echo(hash.to_json) %> 
) 
<% end -%> 
<% end -%> 

> <%= bootstrap_directory %>\client.rb ( 
 <%= config_content %> 
) 

> <%= bootstrap_directory %>\first-boot.json ( 
 <%= first_boot %> 
) 

@echo Starting chef to bootstrap the node... 
<%= start_chef %> 
